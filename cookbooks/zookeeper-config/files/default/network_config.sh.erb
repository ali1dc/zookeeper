#!/bin/bash -e
export GATEWAY=`route -n | grep "^0.0.0.0" | tr -s " " | cut -f2 -d" "`

if [ -f /etc/network/interfaces.d/eth0.cfg ]; then mv -f /etc/network/interfaces.d/eth0.cfg /etc/network/interfaces.d/backup.eth0.cfg.backup; fi
cat > /etc/network/interfaces.d/eth0.cfg <<ETHCFG
auto eth0
iface eth0 inet dhcp
    up ip route add default via $GATEWAY dev eth0 table eth0_rt
    up ip rule add from <%= ipaddr %> lookup eth0_rt prio 1000
ETHCFG

mv /etc/iproute2/rt_tables /etc/iproute2/backup.rt_tables.backup
cat > /etc/iproute2/rt_tables <<RTTABLES
#
# reserved values
#
255     local
254     main
253     default
0       unspec
#
# local
#
#1      inr.ruhep
2 eth0_rt
RTTABLES

ifup eth0

ip route add default via $GATEWAY dev eth0 table eth0_rt ;
ip rule add from <%= ipaddr %> lookup eth0_rt prio 1000 ;
