#!/bin/bash -e
export GATEWAY=`route -n | grep "^0.0.0.0" | tr -s " " | cut -f2 -d" "`

if [ -f /etc/network/interfaces.d/ens4.cfg ]; then mv -f /etc/network/interfaces.d/ens4.cfg /etc/network/interfaces.d/backup.ens4.cfg.backup; fi
cat > /etc/network/interfaces.d/ens4.cfg <<ETHCFG
auto ens4
iface ens4 inet dhcp
    up ip route add default via $GATEWAY dev ens4 table ens4_rt
    up ip rule add from <%= ipaddr %> lookup ens4_rt prio 1000
ETHCFG

mv /etc/iproute2/rt_tables /etc/iproute2/backup.rt_tables.backup
cat > /etc/iproute2/rt_tables <<RTTABLES
#
# reserved values
#
255     local
254     main
253     default
0       unspec
#
# local
#
#1      inr.ruhep
2 ens4_rt
RTTABLES

ifup ens4

ip route add default via $GATEWAY dev ens4 table ens4_rt ;
ip rule add from <%= ipaddr %> lookup ens4_rt prio 1000 ;
